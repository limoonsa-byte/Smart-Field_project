# 스마트 현장관리 (Smart Field) — 전체 코드·파일 구조 파악

> GitHub + 웹앱 폴더 기준 최신 파일 구조 및 코드 요약

---

## 1. 프로젝트 개요

- **앱**: Google Apps Script 웹앱 (V6.1)
- **제목**: 스마트 현장관리 — 도면 → 보관 → 견적까지 한 번에
- **배포**: `doGet()` → `index.html` 템플릿, `include()`로 css / js_*.html 로드
- **데이터**: 동일 스프레드시트 사용 (Script Properties `SPREADSHEET_ID` 또는 `DEFAULT_SPREADSHEET_ID`)

---

## 2. 파일 목록 및 역할

| 파일 | 역할 |
|------|------|
| **appsscript.json** | GAS 프로젝트 설정 (타임존 Asia/Seoul, 웹앱 실행자 USER_DEPLOYING, 접근 ANYONE_ANONYMOUS, V8) |
| **.clasp.json** | clasp 배포용 scriptId, 확장자 설정 |
| **code.js** | 서버 전용: doGet, include, 시트 읽기/쓰기, 도면 저장·목록·삭제, 견적 저장, 일정, 단가표, PDF HTML, 관리자 인증, 품목 저장, setupPriceTables |
| **index.html** | 단일 페이지 앱 진입점. Bootstrap 5 + 아이콘, css include, GAS 배너 제거 스크립트, 5개 화면 div + js_* include |
| **css.html** | 앱 전용 스타일: 배너 제거, 화면 전환, 도면 툴바/캔버스, 반응형(스마트폰/태블릿/PC), 견적·세팅 테이블 등 |
| **js_main.html** | 화면 전환(goScreen), 손모양(화면이동) 모드(setPanMode/togglePanMode), 툴바 토글(toggleToolbar) |
| **js_drawing.html** | 도면 그리기 전부: 캔버스, 벽체/가이드/가구/문, 끊기·되돌리기·직교·스냅, 줌/팬, 저장/구역완성, 치수 입력·구역 모달 |
| **js_history.html** | 도면 보관함: loadList(getDataList→getData 폴백), renderList, 카드 클릭 시 도면 로드/삭제, 모달·풀스크린 뷰어, 연결 확인·연결 정리 |
| **js_estimate.html** | 견적 내기: 단가표 로드, 도면 선택/저장 견적 복원, 공정별 품목 체크·수량·금액, 소계/공과잡비/이윤/조정/총액, 저장, PDF 내보내기(표지+세부) |
| **js_schedule.html** | 일정: 현장 선택(getScheduleList), 일정 조회/저장(getSchedule, saveSchedule), 공정별 노무비·재료비(getScheduleWithLaborAndMaterial), 평일·휴일 제외 일수 계산, 캘린더 UI |
| **js_settings.html** | 관리자 세팅: 비밀번호 인증(verifyAdminPassword), 단가표 로드·품목 편집·저장(savePriceTableItems), 공정별 시트 "(품목)" 관리 |

---

## 3. code.js — 서버 함수 요약

### 3.1 진입·유틸
- `doGet()` — index 템플릿 평가, 제목·뷰포트·XFrame 옵션
- `include(filename)` — HtmlService로 파일 내용 반환
- `getSpreadsheet_()` — Script Properties 또는 DEFAULT_SPREADSHEET_ID로 스프레드시트 반환
- `sanitizeSheetName_(name)` — 시트명 금지 문자 제거, 100자 제한
- `getUniqueSheetName_(ss, baseName)` — 동일 이름 시 (2), (3) 붙여 고유 시트명
- `formatNowKST_()` — Asia/Seoul yyyy-MM-dd HH:mm:ss
- `escapeHtml_(s)` — HTML 이스케이프

### 3.2 도면 보관함 (한 시트 "도면보관함")
- `getDrawingSheet_(ss)` — '도면보관함' 또는 '도면 보관함' 시트 찾기
- `saveToSheet(data)` — JSON 도면 데이터를 도면보관함 시트에 행 추가 (저장시각, 현장명, 천장고, 요약, 데이터 JSON)
- `getDataList()` — 경량 목록: 1~4열만 읽어 현장별 최신 1건 반환 (JSON 배열)
- `getDrawingBySiteName(siteName)` — 해당 현장 최신 도면 JSON 1건 반환
- `getData()` — 도면보관함 전체 읽어 현장별 최신 1건 배열; 없으면 예전 현장별 시트 순회
- `normalizeSiteName_(val)` — 현장명 비교용 정규화
- `getDrawingStorageDiagnostics()` — 사용 중 스프레드시트/시트/데이터 행 수·B열 샘플 반환
- `deleteUnconnectedDrawingRows()` — 현장별 최신 1행만 남기고 나머지 삭제
- `deleteFromSheet(siteName)` — 도면보관함에서 해당 현장명 행 전부 삭제

### 3.3 견적
- `getAllPriceTables()` — 모든 "(품목)" 시트 읽어 공정별 품목 배열 반환 (캐시 180초), 도배필름 → 도배공사/필름공사 분리
- `saveEstimate(estimateData)` — 견적_현장명 시트 생성(덮어쓰기), 공정별 대제목·품목·소계·합계 행 기록
- `getEstimatePdfHtml(siteName)` — 견적_현장명 시트 읽어 표지+상세 HTML 문자열 반환 (서버용 PDF용)
- `savePriceTableItems(category, itemsJson)` — 해당 공정 "(품목)" 시트 전체 덮어쓰기, 캐시 삭제
- `setupPriceTables()` — 단가표 시트 일괄 생성(목공사, 전기, 화장실, 가설철거, 설비, 도배/필름, 바닥, 싱크가구, 도장, 금속유리, 기타)

### 3.4 일정
- `getOrCreateScheduleSheet_(ss)` — '일정' 시트 없으면 헤더와 함께 생성
- `getScheduleList()` — 견적_ 시트명에서 현장명 목록 추출
- `getSchedule(siteName)` — 해당 현장 일정 행 배열 반환
- `getScheduleWithLaborAndMaterial(siteName)` — 일정 + 공정별 노무비·재료비 한 번에
- `saveSchedule(siteName, scheduleData)` — 해당 현장 기존 행 삭제 후 새 일정 행 추가
- `getEstimateLaborByCategory(siteName)` — 견적 시트에서 공정별 노무비금액 합계
- `getEstimateLaborAndMaterialByCategory(siteName)` — 공정별 노무비·재료비 합계 (일정 화면용)

### 3.5 관리자
- `verifyAdminPassword(password)` — 비밀번호 '2021' 일치 여부

---

## 4. 화면 구조 (index.html)

- **screen-main**: 메인 버튼 5개 — 도면 그리기, 도면 보관함, 견적 내기, 일정, 관리자 세팅
- **screen-draw**: 현장명·천장고 입력, 캔버스, 좌측 줌/이동, 우측 툴바(벽체/끊기/되돌리기/직교/스냅/가이드/가구/문/회전/반전/지우개), 하단 닫기·구역완성·저장, 치수 모달·구역 모달
- **screen-list**: 도면 보관함 목록(loadList), 연결 정리·연결 확인 버튼
- **screen-estimate**: 견적 컨테이너(initEstimateScreen에서 도면 선택 또는 저장 견적 복원 후 품목 테이블·요약·저장·PDF)
- **screen-schedule**: 일정 컨테이너(현장 선택, 일정 편집, 캘린더)
- **screen-settings**: 관리자 세팅 컨테이너(비밀번호 후 품목 테이블 편집)

---

## 5. 데이터 흐름 요약

- **도면**: 그리기 → JSON(zones, freeWalls, doors, furnitureLines, guideLines, siteName, height 등) → saveToSheet → 도면보관함 시트
- **도면 목록**: getDataList(경량) 또는 getData(전체) → 현장별 최신 1건 표시
- **견적**: getAllPriceTables → 공정별 품목; 도면 선택 시 getDrawingBySiteName; 체크 품목+수량 → 소계·공과잡비 5%·이윤 10%·조정·총액; saveEstimate → 견적_현장명 시트
- **PDF**: 클라이언트(js_estimate)에서 표지+세부 HTML 생성 → window.open으로 인쇄 대화상자 (또는 서버 getEstimatePdfHtml 사용처 있으면 동일 형식)
- **일정**: getScheduleList → 견적_ 시트명 목록; getSchedule + getEstimateLaborAndMaterialByCategory → 일정+노무/재료; saveSchedule → 일정 시트
- **단가표**: 관리자 세팅에서 (품목) 시트 읽기/저장 → savePriceTableItems, getAllPriceTables 캐시 삭제

---

## 6. 공정(카테고리) 순서

- 도면/견적 공통: 가설철거, 목공사, 전기공사, 설비공사, 화장실공사, 도배필름공사(또는 도배공사/필름공사), 바닥공사, 싱크가구공사, 도장공사, 금속유리공사, 기타공사
- 일정: 가설철거, 설비공사, 목공사, 필름공사, 화장실공사, 전기공사, 도기시공, 도배공사, 바닥공사, 싱크가구공사, 도장공사, 금속유리공사

---

## 7. 견적 PDF (표지)

- 표지: 별첨1, 견 적 서, 공사 명 + 견적일시(오른쪽 끝), 공정별 합계만 테이블(순번·품목·단위·수량·금액·비고), 소계·공과잡비(5%)·이윤(10%)·조정액·총액(VAT 별도) 같은 표 안에, 총액 오른쪽 정렬·숫자+원 한 줄
- 세부: 견적서 상세 내역 — 공정별 대제목 + 품목 상세(No, 품목, 규격, 단위, 수량, 재료비/노무비 단가·금액, 금액), 소계/공과잡비/이윤/조정/총액은 표지에만 있고 세부 페이지에는 없음

---

## 8. 기타

- **관리자 비밀번호**: 2021 (verifyAdminPassword)
- **단가표 캐시**: PRICE_TABLES_CACHE_KEY, TTL 180초
- **도면보관함**: 열 구성 — 저장시각(A), 현장명(B), 천장고(C), 요약(D), 데이터(JSON)(E)

이 문서는 **GitHub 및 웹앱 폴더의 최신 파일**을 기준으로 전체 코드와 파일을 파악한 요약입니다.
