<script>
// =========================
// 전역 변수
// =========================
let settingsPriceTables = {}; // 단가표 전체
let currentCategory = ''; // 현재 선택된 공정
let isAdminAuthenticated = false; // 관리자 인증 상태

// =========================
// ✅ 관리자 세팅 화면 초기화
// =========================
function initSettingsScreen() {
  const container = document.getElementById('settings-container');
  if (!container) return;
  
  // 세션 스토리지에서 인증 상태 확인
  const authStatus = sessionStorage.getItem('adminAuthenticated');
  if (authStatus === 'true') {
    isAdminAuthenticated = true;
    showSettingsContent();
  } else {
    showPasswordModal();
  }
}

// =========================
// ✅ 비밀번호 입력 모달 표시
// =========================
function showPasswordModal() {
  const container = document.getElementById('settings-container');
  if (!container) return;
  
  container.innerHTML = `
    <div class="row justify-content-center mt-5">
      <div class="col-md-6 col-lg-4">
        <div class="card bg-dark border-secondary">
          <div class="card-header text-white text-center">
            <h5 class="mb-0">
              <i class="bi bi-lock-fill"></i> 관리자 인증
            </h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label text-white">비밀번호</label>
              <input type="password" class="form-control bg-dark text-white border-secondary" 
                     id="adminPasswordInput" placeholder="비밀번호를 입력하세요" 
                     onkeypress="if(event.key==='Enter') checkAdminPassword()">
            </div>
            <div class="alert alert-danger d-none" id="passwordError">
              <i class="bi bi-exclamation-triangle"></i> 비밀번호가 올바르지 않습니다.
            </div>
            <button class="btn btn-primary w-100" onclick="checkAdminPassword()">
              <i class="bi bi-box-arrow-in-right"></i> 확인
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // 입력 필드에 포커스
  setTimeout(() => {
    const input = document.getElementById('adminPasswordInput');
    if (input) input.focus();
  }, 100);
}

// =========================
// ✅ 비밀번호 확인
// =========================
function checkAdminPassword() {
  const password = document.getElementById('adminPasswordInput').value;
  const errorDiv = document.getElementById('passwordError');
  
  if (window.google && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(isValid => {
        if (isValid) {
          isAdminAuthenticated = true;
          sessionStorage.setItem('adminAuthenticated', 'true');
          showSettingsContent();
        } else {
          if (errorDiv) {
            errorDiv.classList.remove('d-none');
          }
          document.getElementById('adminPasswordInput').value = '';
          document.getElementById('adminPasswordInput').focus();
        }
      })
      .withFailureHandler(err => {
        alert('인증 오류: ' + (err.message || err));
      })
      .verifyAdminPassword(password);
  } else {
    // 테스트 모드: 기본 비밀번호 "2021"
    if (password === '2021') {
      isAdminAuthenticated = true;
      sessionStorage.setItem('adminAuthenticated', 'true');
      showSettingsContent();
    } else {
      if (errorDiv) {
        errorDiv.classList.remove('d-none');
      }
      document.getElementById('adminPasswordInput').value = '';
      document.getElementById('adminPasswordInput').focus();
    }
  }
}

// =========================
// ✅ 세팅 화면 내용 표시
// =========================
function showSettingsContent() {
  const container = document.getElementById('settings-container');
  if (!container) return;
  
  container.innerHTML = `
    <div class="text-center text-white mt-5">
      <div class="spinner-border text-primary mb-3"></div>
      <h5>품목 데이터를 불러오는 중...</h5>
    </div>
  `;
  
  // 단가표 로드
  loadSettingsPriceTables();
}

// =========================
// ✅ 단가표 로드
// =========================
function loadSettingsPriceTables() {
  if (window.google && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(onSettingsPriceTablesLoaded)
      .withFailureHandler(err => {
        const container = document.getElementById('settings-container');
        if (container) {
          container.innerHTML = `
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle"></i> 단가표 로드 실패<br>
              <small>${err.message || err}</small>
            </div>
          `;
        }
      })
      .getAllPriceTables();
  } else {
    const container = document.getElementById('settings-container');
    if (container) {
      container.innerHTML = `
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle"></i> 테스트 모드: 서버 연결 없음
        </div>
      `;
    }
  }
}

// =========================
// ✅ 단가표 로드 완료
// =========================
function onSettingsPriceTablesLoaded(jsonString) {
  try {
    settingsPriceTables = JSON.parse(jsonString);
    renderSettingsUI();
  } catch (e) {
    const container = document.getElementById('settings-container');
    if (container) {
      container.innerHTML = `
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle"></i> 단가표 파싱 실패<br>
          <small>${e.message}</small>
        </div>
      `;
    }
  }
}

// =========================
// ✅ 관리자 세팅 UI 렌더링
// =========================
function renderSettingsUI() {
  const container = document.getElementById('settings-container');
  if (!container) return;
  
  // 인증 확인
  if (!isAdminAuthenticated && sessionStorage.getItem('adminAuthenticated') !== 'true') {
    showPasswordModal();
    return;
  }
  
  const categoryOrder = [
    '가설철거', '목공사', '전기공사', '설비공사', '화장실공사',
    '도배필름공사', '바닥공사', '싱크가구공사', '도장공사', '금속유리공사', '기타공사'
  ];
  
  let html = `
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="fw-bold m-0 text-white">
        <i class="bi bi-gear-fill"></i> 품목 관리
      </h3>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-warning btn-sm" onclick="logoutAdmin()" title="로그아웃">
          <i class="bi bi-box-arrow-right"></i> 로그아웃
        </button>
        <button class="btn btn-outline-info btn-sm" onclick="refreshSettings()">
          <i class="bi bi-arrow-clockwise"></i> 새로고침
        </button>
      </div>
    </div>
    
    <div class="alert alert-info">
      <i class="bi bi-info-circle"></i> 각 공정별 품목을 추가, 수정, 삭제할 수 있습니다.
      <br><small>변경사항은 즉시 저장되며, 견적 내기 화면에 반영됩니다.</small>
    </div>
    
    <div class="row">
      <!-- 공정 선택 사이드바 -->
      <div class="col-md-3 mb-3">
        <div class="card bg-dark border-secondary">
          <div class="card-header text-white">
            <strong>공정 선택</strong>
          </div>
          <div class="list-group list-group-flush">
  `;
  
  categoryOrder.forEach((cat, idx) => {
    const itemCount = (settingsPriceTables[cat] || []).length;
    const isActive = currentCategory === cat || (idx === 0 && !currentCategory);
    if (idx === 0 && !currentCategory) currentCategory = cat;
    
    html += `
      <button class="list-group-item list-group-item-action ${isActive ? 'active' : 'bg-dark text-white border-secondary'}" 
              onclick="selectCategory('${cat}')">
        <div class="d-flex justify-content-between align-items-center">
          <span><strong>${cat}</strong></span>
          <span class="badge bg-primary">${itemCount}개</span>
        </div>
      </button>
    `;
  });
  
  html += `
          </div>
        </div>
      </div>
      
      <!-- 품목 관리 영역 -->
      <div class="col-md-9">
        <div id="items-management-area"></div>
      </div>
    </div>
  `;
  
  container.innerHTML = html;
  
  // 현재 선택된 공정의 품목 관리 UI 렌더링
  renderItemsManagement();
}

// =========================
// ✅ 공정 선택
// =========================
function selectCategory(category) {
  currentCategory = category;
  renderSettingsUI();
}

// =========================
// ✅ 품목 관리 UI 렌더링
// =========================
function renderItemsManagement() {
  const area = document.getElementById('items-management-area');
  if (!area) return;
  
  const items = settingsPriceTables[currentCategory] || [];
  
  let html = `
    <div class="card bg-dark border-secondary">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0 text-white">
          <i class="bi bi-list-ul"></i> ${currentCategory} 품목 관리
        </h5>
        <div class="d-flex gap-2">
          <button class="btn btn-primary btn-sm" onclick="saveItemsToServer()">
            <i class="bi bi-save"></i> 변경사항 저장
          </button>
          <button class="btn btn-success btn-sm" onclick="showAddItemModal()">
            <i class="bi bi-plus-circle"></i> 품목 추가
          </button>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-dark table-hover mb-0">
            <thead class="table-secondary">
              <tr>
                <th style="width: 50px;">No</th>
                <th>품목</th>
                <th>규격</th>
                <th style="width: 80px;">단위</th>
                <th style="width: 120px;" class="text-end">재료비단가</th>
                <th style="width: 120px;" class="text-end">노무비단가</th>
                <th style="width: 150px;" class="text-center">작업</th>
              </tr>
            </thead>
            <tbody>
  `;
  
  if (items.length === 0) {
    html += `
      <tr>
        <td colspan="7" class="text-center text-muted py-4">
          등록된 품목이 없습니다. <button class="btn btn-link text-success p-0" onclick="showAddItemModal()">품목 추가하기</button>
        </td>
      </tr>
    `;
  } else {
    items.forEach((item, idx) => {
      html += `
        <tr>
          <td>${idx + 1}</td>
          <td>
            <input type="text"
                   class="form-control form-control-sm bg-dark text-white border-secondary"
                   value="${escapeHtml(item.item)}"
                   onchange="updateItemField(${idx}, 'item', this.value)">
          </td>
          <td>
            <input type="text"
                   class="form-control form-control-sm bg-dark text-white border-secondary"
                   value="${escapeHtml(item.spec || '')}"
                   placeholder="-"
                   onchange="updateItemField(${idx}, 'spec', this.value)">
          </td>
          <td>
            <input type="text"
                   class="form-control form-control-sm bg-dark text-white border-secondary text-center"
                   style="max-width: 80px;"
                   value="${item.unit}"
                   onchange="updateItemField(${idx}, 'unit', this.value)">
          </td>
          <td>
            <input type="number"
                   class="form-control form-control-sm bg-dark text-white border-secondary text-end"
                   style="max-width: 120px;"
                   value="${item.materialPrice}"
                   min="0"
                   onchange="updateItemField(${idx}, 'materialPrice', this.value)">
          </td>
          <td>
            <input type="number"
                   class="form-control form-control-sm bg-dark text-white border-secondary text-end"
                   style="max-width: 120px;"
                   value="${item.laborPrice}"
                   min="0"
                   onchange="updateItemField(${idx}, 'laborPrice', this.value)">
          </td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-danger" onclick="deleteItem(${idx})" title="삭제">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `;
    });
  }
  
  html += `
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
  
  area.innerHTML = html;
  
  // 모달 생성
  if (!document.getElementById('itemModal')) {
    createItemModal();
  }
}

// =========================
// ✅ 인라인 수정 값 반영
// =========================
function updateItemField(index, field, value) {
  if (!settingsPriceTables[currentCategory] ||
      !settingsPriceTables[currentCategory][index]) {
    return;
  }
  const item = settingsPriceTables[currentCategory][index];
  
  if (field === 'materialPrice' || field === 'laborPrice') {
    item[field] = Number(value) || 0;
  } else {
    item[field] = String(value || '').trim();
  }
}

// =========================
// ✅ 품목 추가 모달 표시
// =========================
function showAddItemModal() {
  document.getElementById('itemModalTitle').textContent = '품목 추가';
  document.getElementById('itemModalItem').value = '';
  document.getElementById('itemModalSpec').value = '';
  document.getElementById('itemModalUnit').value = '';
  document.getElementById('itemModalMaterialPrice').value = '0';
  document.getElementById('itemModalLaborPrice').value = '0';
  document.getElementById('itemModalSaveBtn').onclick = saveNewItem;
  
  const modal = new bootstrap.Modal(document.getElementById('itemModal'));
  modal.show();
}

// =========================
// ✅ 품목 수정 모달 표시
// =========================
function editItem(index) {
  const items = settingsPriceTables[currentCategory] || [];
  const item = items[index];
  
  if (!item) return;
  
  document.getElementById('itemModalTitle').textContent = '품목 수정';
  document.getElementById('itemModalItem').value = item.item;
  document.getElementById('itemModalSpec').value = item.spec || '';
  document.getElementById('itemModalUnit').value = item.unit;
  document.getElementById('itemModalMaterialPrice').value = item.materialPrice;
  document.getElementById('itemModalLaborPrice').value = item.laborPrice;
  document.getElementById('itemModalSaveBtn').onclick = () => saveEditedItem(index);
  
  const modal = new bootstrap.Modal(document.getElementById('itemModal'));
  modal.show();
}

// =========================
// ✅ 새 품목 저장
// =========================
function saveNewItem() {
  const item = document.getElementById('itemModalItem').value.trim();
  const spec = document.getElementById('itemModalSpec').value.trim();
  const unit = document.getElementById('itemModalUnit').value.trim();
  const materialPrice = Number(document.getElementById('itemModalMaterialPrice').value) || 0;
  const laborPrice = Number(document.getElementById('itemModalLaborPrice').value) || 0;
  
  if (!item) {
    alert('품목명을 입력하세요.');
    return;
  }
  
  if (!unit) {
    alert('단위를 입력하세요.');
    return;
  }
  
  // 품목 추가
  if (!settingsPriceTables[currentCategory]) {
    settingsPriceTables[currentCategory] = [];
  }
  
  settingsPriceTables[currentCategory].push({
    item: item,
    spec: spec,
    unit: unit,
    materialPrice: materialPrice,
    laborPrice: laborPrice
  });
  
  // 서버에 저장
  saveItemsToServer();
}

// =========================
// ✅ 품목 수정 저장
// =========================
function saveEditedItem(index) {
  const item = document.getElementById('itemModalItem').value.trim();
  const spec = document.getElementById('itemModalSpec').value.trim();
  const unit = document.getElementById('itemModalUnit').value.trim();
  const materialPrice = Number(document.getElementById('itemModalMaterialPrice').value) || 0;
  const laborPrice = Number(document.getElementById('itemModalLaborPrice').value) || 0;
  
  if (!item) {
    alert('품목명을 입력하세요.');
    return;
  }
  
  if (!unit) {
    alert('단위를 입력하세요.');
    return;
  }
  
  // 품목 수정
  if (settingsPriceTables[currentCategory] && settingsPriceTables[currentCategory][index]) {
    settingsPriceTables[currentCategory][index] = {
      item: item,
      spec: spec,
      unit: unit,
      materialPrice: materialPrice,
      laborPrice: laborPrice
    };
  }
  
  // 서버에 저장
  saveItemsToServer();
}

// =========================
// ✅ 품목 삭제
// =========================
function deleteItem(index) {
  if (!confirm('이 품목을 삭제하시겠습니까?')) return;
  
  if (settingsPriceTables[currentCategory] && settingsPriceTables[currentCategory][index]) {
    settingsPriceTables[currentCategory].splice(index, 1);
  }
  
  // 서버에 저장
  saveItemsToServer();
}

// =========================
// ✅ 서버에 품목 저장
// =========================
function saveItemsToServer() {
  const items = settingsPriceTables[currentCategory] || [];
  
  if (window.google && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(res => {
        alert(res);
        // UI 새로고침
        renderItemsManagement();
      })
      .withFailureHandler(err => {
        alert('❌ 저장 실패: ' + (err.message || err));
      })
      .savePriceTableItems(currentCategory, JSON.stringify(items));
  } else {
    alert('테스트 모드: 저장 기능은 실제 환경에서만 작동합니다.');
    renderItemsManagement();
  }
}

// =========================
// ✅ 새로고침
// =========================
function refreshSettings() {
  // 인증 상태 유지하면서 새로고침
  if (isAdminAuthenticated || sessionStorage.getItem('adminAuthenticated') === 'true') {
    showSettingsContent();
  } else {
    initSettingsScreen();
  }
}

// =========================
// ✅ 관리자 로그아웃
// =========================
function logoutAdmin() {
  if (confirm('관리자 세팅에서 로그아웃하시겠습니까?')) {
    isAdminAuthenticated = false;
    sessionStorage.removeItem('adminAuthenticated');
    showPasswordModal();
  }
}

// =========================
// ✅ 품목 모달 생성
// =========================
function createItemModal() {
  const modalHTML = `
    <div class="modal fade" id="itemModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-secondary">
          <div class="modal-header border-secondary">
            <h5 class="modal-title" id="itemModalTitle">품목 추가</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">품목명 <span class="text-danger">*</span></label>
              <input type="text" class="form-control bg-dark text-white border-secondary" id="itemModalItem" required>
            </div>
            <div class="mb-3">
              <label class="form-label">규격</label>
              <input type="text" class="form-control bg-dark text-white border-secondary" id="itemModalSpec">
            </div>
            <div class="mb-3">
              <label class="form-label">단위 <span class="text-danger">*</span></label>
              <input type="text" class="form-control bg-dark text-white border-secondary" id="itemModalUnit" required>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">재료비단가</label>
                <input type="number" class="form-control bg-dark text-white border-secondary" id="itemModalMaterialPrice" value="0" min="0">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">노무비단가</label>
                <input type="number" class="form-control bg-dark text-white border-secondary" id="itemModalLaborPrice" value="0" min="0">
              </div>
            </div>
          </div>
          <div class="modal-footer border-secondary">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            <button type="button" class="btn btn-primary" id="itemModalSaveBtn">저장</button>
          </div>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// =========================
// ✅ HTML 이스케이프
// =========================
function escapeHtml(text) {
  if (text == null) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
