# 구글 시트 + 앱스크립트 구조 정리

## 1. 전체 구조

- **앱 진입점**: Google Apps Script **웹 앱** (`doGet()` → `index.html` 제공)
- **데이터 저장소**: **같은 스프레드시트** 한 권
  - 스크립트는 `SpreadsheetApp.getActiveSpreadsheet()` 로 **현재 열려 있는(또는 배포가 연결된) 스프레드시트**를 사용합니다.
- **사용 흐름**: 웹 앱 URL로 접속 → 도면 그리기 / 도면 보관함 / 견적 내기 / 관리자 세팅 → 모두 **그 스프레드시트**의 시트를 읽고 씁니다.

---

## 2. 구글 시트 사용 현황

### 2-1. 도면보관함 (시트 1개)

| 시트명 | 용도 | 컬럼 |
|--------|------|------|
| **도면보관함** | 도면 저장/목록/불러오기/삭제 | 저장시각, 현장명, 천장고, 요약, 데이터(JSON) |

- **저장**: 도면 그리기에서 저장 시 → 위 시트에 **한 행** 추가 (JSON 한 셀에 전체 도면 데이터)
- **목록**: `getDataList()` → 1~4열만 읽어서 경량 목록 반환 (JSON 제외)
- **한 건 불러오기**: `getDrawingBySiteName(현장명)` → 5열 JSON만 파싱해서 반환
- **전체 불러오기**: `getData()` → 도면보관함 전체 읽어서 JSON 배열 반환 (도면보관함 없으면 예전 방식: 현장별 시트 순회)
- **삭제**: `deleteFromSheet(현장명)` → 해당 현장 **최신 1행** 삭제

시트가 없으면 스크립트가 **자동 생성** (헤더 1행 + 컬럼 너비 등).

---

### 2-2. 견적서 저장 (현장별 시트)

| 시트명 패턴 | 용도 |
|-------------|------|
| **견적_현장명** | 서버 저장한 견적서 1건 (예: 견적_OO아파트) |

- **저장**: 견적 내기에서 "서버 저장" 시 → `견적_` + 현장명 시트를 **덮어쓰기** (기존 시트 삭제 후 새로 생성)
- **내용**: 현장명, 평수, 작성일, No/품목/규격/단위/수량/재료·노무/금액, 소계·공과잡비·이윤·조정액·총액

시트명에 `\ / ? * [ ]` 등은 스크립트에서 제거 후 사용 (`sanitizeSheetName_`).

---

### 2-3. 단가표 (공정별 품목 시트)

| 시트명 패턴 | 용도 |
|-------------|------|
| **가설철거(품목)** | 가설철거 품목·규격·단위·재료비·노무비 |
| **목공사(품목)** | 목공사 품목 … |
| **전기공사(품목)** | 전기공사 품목 … |
| **설비공사(품목)** | 설비공사 품목 … |
| **화장실공사(품목)** | 화장실공사 품목 … (욕실액서사리, 티오람 미니 등) |
| **도배필름공사(품목)** | 도배·필름 품목 … |
| **바닥공사(품목)** | 바닥공사 품목 … |
| **싱크가구공사(품목)** | 싱크·가구 품목 … |
| **도장공사(품목)** | 도장공사 품목 … |
| **금속유리공사(품목)** | 금속·유리 품목 … |
| **기타공사(품목)** | 기타공사 품목 … |

- **읽기**: `getAllPriceTables()` → 이름에 `(품목)` 이 들어간 시트만 읽어서 JSON으로 반환. **캐시 180초** 사용.
- **쓰기**: 관리자 세팅에서 품목 저장 시 `savePriceTableItems(공정명, itemsJson)` → 해당 `공정명(품목)` 시트를 **한 번에 setValues**로 갱신, 캐시 삭제.
- **최초 생성**: 스크립트 에디터에서 `setupPriceTables()` 실행 시 **code.js 안에 정의된** 단가표로 위 시트들을 **한 번에 생성** (기존 동일 이름 시트는 삭제 후 재생성).

---

## 3. 앱스크립트(code.js) 역할 요약

| 함수 | 역할 |
|------|------|
| **doGet()** | 웹 앱 진입. `index` 템플릿으로 HTML 제공, 제목·뷰포트·XFrameOptions 설정 |
| **include(filename)** | HTML 조각 포함 (css, js_main, js_drawing 등) |
| **saveToSheet(data)** | 도면 JSON → 도면보관함 시트에 1행 추가 |
| **getDataList()** | 도면보관함 1~4열만 읽어 경량 목록 JSON 반환 |
| **getDrawingBySiteName(siteName)** | 현장명으로 해당 도면 JSON 1건 반환 |
| **getData()** | 도면보관함 전체 또는 예전 방식으로 도면 목록 JSON 반환 |
| **deleteFromSheet(siteName)** | 도면보관함에서 해당 현장 최신 1행 삭제 |
| **getAllPriceTables()** | 모든 `(품목)` 시트 읽어 단가표 JSON 반환 (캐시 사용) |
| **saveEstimate(estimateData)** | 견적 JSON → `견적_현장명` 시트 생성(덮어쓰기) |
| **savePriceTableItems(category, itemsJson)** | 해당 공정 `(품목)` 시트 저장, 캐시 무효화 |
| **verifyAdminPassword(password)** | 관리자 비밀번호 확인 (고정값 '2021') |
| **setupPriceTables()** | 단가표 시트 일괄 생성 (에디터에서 수동 실행) |

- **Lock**: `saveToSheet`, `deleteFromSheet`, `saveEstimate`, `savePriceTableItems` 에서 `LockService.getScriptLock()` 사용 (동시 수정 방지).
- **시트가 없을 때**: 도면보관함은 스크립트가 자동 생성. 단가표는 `setupPriceTables()` 또는 관리자에서 저장 시 시트 없으면 생성.

---

## 4. “새 창에서 열기”가 여는 주소

- 웹 앱은 **스프레드시트와 별개**로 배포된 **Apps Script 웹 앱 URL**로 열립니다.
- 형식 예: `https://script.google.com/macros/s/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx/exec`
- “새 창에서 열기”는 **현재 페이지 URL**을 그대로 `window.open(..., '_blank')` 로 여는 것이므로, **같은 웹 앱 URL**이 새 탭에서 열립니다.  
  → **구글 시트 파일 자체를 여는 것이 아니라**, “스마트 현장관리” 웹 앱이 다시 열리는 것입니다.
- 이 웹 앱이 **어느 스프레드시트**를 쓰는지는 **배포/연결**에 따라 정해집니다.  
  - 보통 **스프레드시트에서 “앱”으로 실행**하거나, **그 스프레드시트에 연결된 스크립트**로 배포했을 경우, `getActiveSpreadsheet()` 는 **그 스프레드시트**를 가리킵니다.

---

## 5. 한 줄 요약

- **구글 시트**: 도면보관함 1시트 + 견적_현장명 시트들 + 공정별 `(품목)` 단가표 시트들.
- **앱스크립트**: 같은 스프레드시트를 기준으로 도면/견적/단가표를 읽고 쓰고, `doGet()`으로 웹 앱 HTML을 제공합니다.
