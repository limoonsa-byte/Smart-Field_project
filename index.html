<!DOCTYPE html>
<html lang="ko">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <?!= include('css'); ?>

  <script>
    // ✅ Google Apps Script 배너 제거
    document.addEventListener('DOMContentLoaded', function() {
      // 배너 요소 찾아서 제거
      const banners = document.querySelectorAll('[class*="banner"], [id*="banner"], [style*="e8f0fe"], [style*="rgb(232, 240, 254)"]');
      banners.forEach(banner => {
        if (banner.textContent && banner.textContent.includes('Google Apps Script')) {
          banner.remove();
        }
      });
      
      // 동적으로 추가되는 배너도 제거
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1) { // Element node
              if (node.textContent && node.textContent.includes('Google Apps Script')) {
                node.remove();
              }
              // 자식 요소도 확인
              const childBanners = node.querySelectorAll('[class*="banner"], [id*="banner"]');
              childBanners.forEach(banner => {
                if (banner.textContent && banner.textContent.includes('Google Apps Script')) {
                  banner.remove();
                }
              });
            }
          });
        });
      });
      
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
    });
    
    // ✅ 화면에서 바로 에러 확인 (모바일에서도 원인 잡기 쉬움)
    window.addEventListener('error', (e) => {
      alert('JS 오류: ' + (e.message || e.error) + '\n(' + (e.filename || '') + ':' + (e.lineno || '') + ')');
    });
    window.addEventListener('unhandledrejection', (e) => {
      alert('Promise 오류: ' + (e.reason?.message || e.reason));
    });
  </script>
</head>

<body>

<!-- 메인 -->
<div id="screen-main" class="screen active">
  <div class="container text-center" style="margin-top: 15vh;">
    <h1 class="fw-bold text-white mb-2">스마트 현장관리 <span class="badge bg-primary">V6.1</span></h1>
    <p class="text-secondary mb-5">도면 → 보관 → 견적까지 한 번에</p>

    <div class="d-grid gap-3 col-10 mx-auto" style="max-width: 420px;">
      <button class="btn btn-primary btn-lg py-3 fw-bold shadow" onclick="goScreen('draw')">
        <i class="bi bi-pencil-square me-2"></i> 도면 그리기
      </button>
      <button class="btn btn-success btn-lg py-3 fw-bold shadow" onclick="goScreen('list')">
        <i class="bi bi-folder2-open me-2"></i> 도면 보관함
      </button>
      <button class="btn btn-info btn-lg py-3 fw-bold shadow text-white" onclick="goScreen('estimate')">
        <i class="bi bi-calculator me-2"></i> 견적 내기
      </button>
      <button class="btn btn-warning btn-lg py-3 fw-bold shadow" onclick="goScreen('settings')">
        <i class="bi bi-gear-fill me-2"></i> 관리자 세팅
      </button>
    </div>
  </div>
</div>

<!-- 도면 그리기 -->
<div id="screen-draw" class="screen">
  <div id="top-bar">
    <button class="btn btn-secondary btn-sm" onclick="goScreen('main')">
      <i class="bi bi-house"></i> 홈
    </button>

    <input type="text" id="siteName" class="form-control form-control-sm"
           style="flex: 1; max-width: 160px;" placeholder="현장명 (필수)" required>

    <div class="input-group input-group-sm" style="width: 150px;">
      <span class="input-group-text bg-secondary text-white border-secondary">H</span>
      <input type="number" id="wallHeight" class="form-control bg-dark text-white border-secondary" value="2300">
    </div>
  </div>

  <div id="info-overlay">
    <span class="text-warning fw-bold" id="mode-display">현재: 벽체</span>
  </div>

  <div id="canvas-wrapper">
    <canvas id="cadCanvas"></canvas>
  </div>

  <!-- ✅ 줌/이동 컨트롤 (도면그리기) -->
  <div id="nav-controls">
    <div class="nav-row">
      <button type="button" class="nav-btn" id="btn-pan-left" onclick="togglePanMode()" title="화면이동">
        <i class="bi bi-hand-index-thumb"></i>
      </button>
    </div>
    <div class="nav-row">
      <button type="button" class="nav-btn" onclick="zoomAtCenter(1.15)" title="확대">
        <i class="bi bi-zoom-in"></i>
      </button>
    </div>
    <div class="nav-row">
      <button type="button" class="nav-btn" onclick="zoomAtCenter(1/1.15)" title="축소">
        <i class="bi bi-zoom-out"></i>
      </button>
    </div>
    <div class="nav-row">
      <button type="button" class="nav-btn" onclick="zoomFit()" title="도면 전체 보기">
        <i class="bi bi-fullscreen"></i>
      </button>
    </div>
  </div>

  <!-- ✅ 툴바 숨김/펼치기 버튼 (right-controls 바깥!) -->
  <button id="toolbar-toggle" type="button" onclick="toggleToolbar()" aria-label="툴바 숨김/펼치기">
    <i class="bi bi-layout-sidebar-inset"></i>
  </button>

  <!-- 우측 툴바 -->
  <div id="right-controls">

    <button class="tool-btn active" id="btn-wall" onclick="setMode('wall')">
      <i class="bi bi-square"></i><span>벽체</span>
    </button>

    <button class="tool-btn" onclick="breakLine()">
      <i class="bi bi-scissors"></i><span>끊기</span>
    </button>

    <button class="tool-btn text-warning" onclick="undo()">
      <i class="bi bi-arrow-counterclockwise"></i><span>되돌리기</span>
    </button>

    <button class="tool-btn active" id="btnOrtho" onclick="toggleOrtho()">
      <i class="bi bi-bounding-box-circles"></i><span>직교</span>
    </button>

    <button class="tool-btn active" id="btnSnap" onclick="toggleSnap()">
      <i class="bi bi-magnet"></i><span>자석</span>
    </button>

    <div class="divider"></div>

    <button class="tool-btn text-info" id="btn-closet" onclick="setMode('furniture','closet')">
      <i class="bi bi-archive"></i><span>붙박이</span>
    </button>

    <button class="tool-btn text-warning" id="btn-shoes" onclick="setMode('furniture','shoes')">
      <i class="bi bi-box-seam"></i><span>신발장</span>
    </button>

    <button class="tool-btn text-success" id="btn-sink" onclick="setMode('furniture','sink')">
      <i class="bi bi-water"></i><span>싱크대</span>
    </button>

    <button class="tool-btn door-type-btn active text-danger" data-door-type="room" onclick="setDoorType('room'); addDoor();">
      <i class="bi bi-door-open"></i><span>방문</span>
    </button>
    
    <button class="tool-btn door-type-btn text-success" data-door-type="entrance" onclick="setDoorType('entrance'); addDoor();">
      <i class="bi bi-door-closed"></i><span>현관문</span>
    </button>
    
    <button class="tool-btn door-type-btn text-info" data-door-type="veranda" onclick="setDoorType('veranda'); addDoor();">
      <i class="bi bi-door-open-fill"></i><span>베란다문</span>
    </button>
    
    <button class="tool-btn door-type-btn text-warning" data-door-type="middle" onclick="setDoorType('middle'); addDoor();">
      <i class="bi bi-dash-square"></i><span>중문</span>
    </button>

    <div class="divider"></div>

    <button class="tool-btn text-warning" onclick="rotateItem()">
      <i class="bi bi-arrow-clockwise"></i><span>회전</span>
    </button>

    <button class="tool-btn text-warning" onclick="flipItem()">
      <i class="bi bi-arrow-left-right"></i><span>반전</span>
    </button>

    <button class="tool-btn text-secondary" id="btn-delete" onclick="setMode('delete')">
      <i class="bi bi-eraser-fill"></i><span>지우개</span>
    </button>
  </div>

  <!-- 하단 버튼 -->
  <div id="bottom-controls">
    <button class="btn btn-warning rounded-pill shadow" onclick="closeLoop()">🔒 닫기</button>
    <button class="btn btn-light rounded-pill shadow" onclick="finishZone()">🏁 구역완성</button>
    <button class="btn btn-success rounded-pill shadow" onclick="saveDataToServer()">💾 저장</button>
  </div>

  <!-- 치수 입력 모달 -->
  <div class="center-modal" id="inputModal">
    <h5 id="inputTitle">벽 길이(mm) 입력</h5>
    <input id="lengthInput" type="number" class="form-control" placeholder="1000">
    <div class="d-grid gap-2">
      <button class="btn btn-primary" onclick="confirmInput()">확인</button>
      <button class="btn btn-secondary" onclick="cancelInput()">취소</button>
    </div>
  </div>

  <!-- 구역 모달(드롭다운) -->
  <div class="modal fade" id="zoneModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">구역 저장</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <p class="mb-2">면적: <span class="fw-bold" id="modalArea">0</span> m²</p>

          <select id="zoneNameSelect" class="form-select mb-2">
            <option value="거실">거실</option>
            <option value="주방">주방</option>
            <option value="안방">안방</option>
            <option value="방">방</option>
            <option value="욕실">욕실</option>
            <option value="발코니">발코니</option>
            <option value="현관">현관</option>
            <option value="다용도실">다용도실</option>
            <option value="복도">복도</option>
            <option value="기타(직접입력)">기타(직접입력)</option>
          </select>

          <input type="text" class="form-control" id="zoneNameInput" placeholder="기타 선택 시 직접 입력">
          <small class="text-secondary d-block mt-2">
            * 욕실/방/발코니는 자동으로 번호가 붙습니다 (예: 욕실, 욕실2, 욕실3)
          </small>
        </div>

        <div class="modal-footer">
          <button class="btn btn-primary fw-bold" onclick="saveZone()">저장</button>
        </div>
      </div>
    </div>
  </div>

</div>
<!-- /screen-draw -->

<!-- 보관함 -->
<div id="screen-list" class="screen">
  <div class="bg-dark p-3 sticky-top border-bottom border-secondary d-flex justify-content-between align-items-center">
    <button class="btn btn-secondary btn-sm" onclick="goScreen('main')"><i class="bi bi-house"></i> 홈</button>
    <h5 class="text-white m-0 fw-bold">도면 보관함</h5>
    <div style="width:60px;"></div>
  </div>
  <div class="container py-3" id="list-container"></div>
</div>

<!-- 견적 -->
<div id="screen-estimate" class="screen">
  <div class="bg-dark p-3 sticky-top border-bottom border-secondary d-flex justify-content-between align-items-center">
    <button class="btn btn-secondary btn-sm" onclick="goScreen('main')"><i class="bi bi-house"></i> 홈</button>
    <h5 class="text-white m-0 fw-bold">견적 내기</h5>
    <div style="width:60px;"></div>
  </div>
  <div class="container py-3" id="estimate-container"></div>
</div>

<!-- 관리자 세팅 -->
<div id="screen-settings" class="screen">
  <div class="bg-dark p-3 sticky-top border-bottom border-secondary d-flex justify-content-between align-items-center">
    <button class="btn btn-secondary btn-sm" onclick="goScreen('main')"><i class="bi bi-house"></i> 홈</button>
    <h5 class="text-white m-0 fw-bold"><i class="bi bi-gear-fill"></i> 관리자 세팅</h5>
    <div style="width:60px;"></div>
  </div>
  <div class="container py-3" id="settings-container"></div>
</div>

<!-- 스크립트 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<?!= include('js_main'); ?>
<?!= include('js_drawing'); ?>
<?!= include('js_history'); ?>
<?!= include('js_estimate'); ?>
<?!= include('js_settings'); ?>

</body>
</html>
