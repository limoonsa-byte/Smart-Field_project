<!DOCTYPE html>
<html lang="ko">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <meta name="theme-color" content="#222222">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <?!= include('css'); ?>

  <script>
    // ✅ Google Apps Script 배너 즉시 제거 (DOMContentLoaded 전에 실행)
    (function() {
      function removeBanner() {
        // 모든 가능한 배너 선택자로 찾기
        const selectors = [
          'body > div:first-child',
          '[class*="banner"]',
          '[id*="banner"]',
          '[class*="gb_"]',
          '[id*="gb_"]',
          'div[style*="e8f0fe"]',
          'div[style*="rgb(232, 240, 254)"]',
          'a[href*="script.google.com"]',
          'a[href*="developers.google.com"]'
        ];
        
        selectors.forEach(selector => {
          try {
            const elements = document.querySelectorAll(selector);
            elements.forEach(el => {
              const text = el.textContent || el.innerText || '';
              if (text.includes('Google Apps Script') || 
                  text.includes('애플리케이션은 Google') ||
                  text.includes('자세히 알아보기') ||
                  el.style.backgroundColor === 'rgb(232, 240, 254)' ||
                  el.style.backgroundColor === '#e8f0fe') {
                el.remove();
                el.style.display = 'none';
                el.style.visibility = 'hidden';
                el.style.height = '0';
                el.style.overflow = 'hidden';
              }
            });
          } catch(e) {}
        });
        
        // body의 첫 번째 자식이 배너일 가능성이 높음
        if (document.body && document.body.firstElementChild) {
          const firstChild = document.body.firstElementChild;
          const text = firstChild.textContent || firstChild.innerText || '';
          const bgColor = window.getComputedStyle(firstChild).backgroundColor;
          if (text.includes('Google Apps Script') || 
              text.includes('애플리케이션은 Google') ||
              bgColor.includes('232, 240, 254') ||
              bgColor.includes('e8f0fe')) {
            firstChild.remove();
            firstChild.style.display = 'none';
          }
        }
      }
      
      // 즉시 실행
      removeBanner();
      
      // DOMContentLoaded 시에도 실행
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', removeBanner);
      } else {
        removeBanner();
      }
      
      // 동적으로 추가되는 배너도 제거
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1) {
              const text = node.textContent || node.innerText || '';
              const bgColor = node.style ? node.style.backgroundColor : '';
              if (text.includes('Google Apps Script') || 
                  text.includes('애플리케이션은 Google') ||
                  bgColor.includes('e8f0fe') ||
                  bgColor.includes('232, 240, 254')) {
                node.remove();
                node.style.display = 'none';
              }
              var children = node.querySelectorAll ? node.querySelectorAll('*') : [];
              children.forEach(function(child) {
                var childText = child.textContent || child.innerText || '';
                if (childText.includes('Google Apps Script') || 
                    childText.includes('애플리케이션은 Google')) {
                  child.remove();
                }
              });
            }
          });
        });
        removeBanner();
      });
      
      observer.observe(document.body || document.documentElement, {
        childList: true,
        subtree: true
      });
      
      setInterval(removeBanner, 100);
    })();
    
    // ✅ 화면에서 바로 에러 확인 (모바일에서도 원인 잡기 쉬움)
    window.addEventListener('error', (e) => {
      alert('JS 오류: ' + (e.message || e.error) + '\n(' + (e.filename || '') + ':' + (e.lineno || '') + ')');
    });
    window.addEventListener('unhandledrejection', (e) => {
      alert('Promise 오류: ' + (e.reason?.message || e.reason));
    });
  </script>
</head>

<body>

<!-- 메인 -->
<div id="screen-main" class="screen active">
  <div class="container text-center main-buttons-wrap">
    <h1 class="fw-bold text-white mb-2 main-title">스마트 현장관리 <span class="badge bg-primary">V6.1</span></h1>
    <p class="text-secondary mb-4 mb-md-5 main-subtitle">도면 → 보관 → 견적까지 한 번에</p>

    <div class="d-grid gap-3 main-buttons">
      <button type="button" class="btn btn-primary btn-lg py-3 fw-bold shadow touch-btn" onclick="goScreen('draw')">
        <i class="bi bi-pencil-square me-2"></i> 도면 그리기
      </button>
      <button type="button" class="btn btn-success btn-lg py-3 fw-bold shadow touch-btn" onclick="goScreen('list')">
        <i class="bi bi-folder2-open me-2"></i> 도면 보관함
      </button>
      <button type="button" class="btn btn-info btn-lg py-3 fw-bold shadow text-white touch-btn" onclick="goScreen('estimate')">
        <i class="bi bi-calculator me-2"></i> 견적 내기
      </button>
      <button type="button" class="btn btn-secondary btn-lg py-3 fw-bold shadow touch-btn" onclick="goScreen('schedule')">
        <i class="bi bi-calendar3 me-2"></i> 일정
      </button>
      <button type="button" class="btn btn-warning btn-lg py-3 fw-bold shadow touch-btn" onclick="goScreen('settings')">
        <i class="bi bi-gear-fill me-2"></i> 관리자 세팅
      </button>
    </div>
  </div>
</div>

<!-- 도면 그리기 -->
<div id="screen-draw" class="screen">
  <div id="top-bar" class="d-flex align-items-center flex-wrap">
    <button type="button" class="btn btn-secondary btn-sm touch-btn" onclick="goScreen('main')">
      <i class="bi bi-house"></i> <span class="topbar-label">홈</span>
    </button>
    <input type="text" id="siteName" class="form-control form-control-sm topbar-site"
           placeholder="현장명 (필수)" required>
    <div class="input-group input-group-sm topbar-height">
      <span class="input-group-text bg-secondary text-white border-secondary">H</span>
      <input type="number" id="wallHeight" class="form-control bg-dark text-white border-secondary" value="2300">
    </div>
  </div>

  <div id="info-overlay">
    <span class="text-warning fw-bold" id="mode-display">현재: 벽체</span>
  </div>

  <div id="canvas-wrapper">
    <canvas id="cadCanvas"></canvas>
  </div>

  <!-- ✅ 줌/이동 컨트롤 (도면그리기) -->
  <div id="nav-controls">
    <div class="nav-row">
      <button type="button" class="nav-btn" id="btn-pan-left" onclick="togglePanMode()" title="화면이동">
        <i class="bi bi-hand-index-thumb"></i>
      </button>
    </div>
    <div class="nav-row">
      <button type="button" class="nav-btn" onclick="zoomAtCenter(1.15)" title="확대">
        <i class="bi bi-zoom-in"></i>
      </button>
    </div>
    <div class="nav-row">
      <button type="button" class="nav-btn" onclick="zoomAtCenter(1/1.15)" title="축소">
        <i class="bi bi-zoom-out"></i>
      </button>
    </div>
    <div class="nav-row">
      <button type="button" class="nav-btn" onclick="zoomFit()" title="도면 전체 보기">
        <i class="bi bi-fullscreen"></i>
      </button>
    </div>
  </div>

  <!-- ✅ 툴바 숨김/펼치기 버튼 (right-controls 바깥!) -->
  <button id="toolbar-toggle" type="button" onclick="toggleToolbar()" aria-label="툴바 숨김/펼치기">
    <i class="bi bi-layout-sidebar-inset"></i>
  </button>

  <!-- 우측 툴바 -->
  <div id="right-controls">

    <button class="tool-btn active" id="btn-wall" onclick="setMode('wall')">
      <i class="bi bi-square"></i><span>벽체</span>
    </button>

    <button class="tool-btn" onclick="breakLine()">
      <i class="bi bi-scissors"></i><span>끊기</span>
    </button>

    <button class="tool-btn text-warning" onclick="undo()">
      <i class="bi bi-arrow-counterclockwise"></i><span>되돌리기</span>
    </button>

    <button class="tool-btn active" id="btnOrtho" onclick="toggleOrtho()">
      <i class="bi bi-bounding-box-circles"></i><span>직교</span>
    </button>

    <button class="tool-btn active" id="btnSnap" onclick="toggleSnap()">
      <i class="bi bi-magnet"></i><span>자석</span>
    </button>

    <button class="tool-btn text-warning" id="btn-guide" onclick="setMode('guide')">
      <i class="bi bi-dash-lg"></i><span>가이드선</span>
    </button>

    <div class="divider"></div>

    <button class="tool-btn text-info" id="btn-closet" onclick="setMode('furniture','closet')">
      <i class="bi bi-archive"></i><span>붙박이</span>
    </button>

    <button class="tool-btn text-warning" id="btn-shoes" onclick="setMode('furniture','shoes')">
      <i class="bi bi-box-seam"></i><span>신발장</span>
    </button>

    <button class="tool-btn text-success" id="btn-sink" onclick="setMode('furniture','sink')">
      <i class="bi bi-water"></i><span>싱크대</span>
    </button>

    <button class="tool-btn text-secondary" id="btn-low" onclick="setMode('furniture','low')">
      <i class="bi bi-box"></i><span>낮은장</span>
    </button>

    <button class="tool-btn door-type-btn active text-danger" data-door-type="room" onclick="setDoorType('room'); addDoor();">
      <i class="bi bi-door-open"></i><span>방문</span>
    </button>
    
    <button class="tool-btn door-type-btn text-success" data-door-type="entrance" onclick="setDoorType('entrance'); addDoor();">
      <i class="bi bi-door-closed"></i><span>현관문</span>
    </button>
    
    <button class="tool-btn door-type-btn text-info" data-door-type="veranda" onclick="setDoorType('veranda'); addDoor();">
      <i class="bi bi-door-open-fill"></i><span>베란다문</span>
    </button>
    
    <button class="tool-btn door-type-btn text-warning" data-door-type="middle" onclick="setDoorType('middle'); addDoor();">
      <i class="bi bi-dash-square"></i><span>중문</span>
    </button>

    <div class="divider"></div>

    <button class="tool-btn text-warning" onclick="rotateItem()">
      <i class="bi bi-arrow-clockwise"></i><span>회전</span>
    </button>

    <button class="tool-btn text-warning" onclick="flipItem()">
      <i class="bi bi-arrow-left-right"></i><span>반전</span>
    </button>

    <button class="tool-btn text-secondary" id="btn-delete" onclick="setMode('delete')">
      <i class="bi bi-eraser-fill"></i><span>지우개</span>
    </button>
  </div>

  <!-- 하단 버튼 -->
  <div id="bottom-controls">
    <button class="btn btn-warning rounded-pill shadow" onclick="closeLoop()">🔒 닫기</button>
    <button class="btn btn-light rounded-pill shadow" onclick="finishZone()">🏁 구역완성</button>
    <button class="btn btn-success rounded-pill shadow" onclick="saveDataToServer()">💾 저장</button>
  </div>

  <!-- 치수 입력 모달 -->
  <div class="center-modal" id="inputModal">
    <h5 id="inputTitle">벽 길이(mm) 입력</h5>
    <input id="lengthInput" type="number" class="form-control" placeholder="1000">
    <div class="d-grid gap-2">
      <button class="btn btn-primary" onclick="confirmInput()">확인</button>
      <button class="btn btn-secondary" onclick="cancelInput()">취소</button>
    </div>
  </div>

  <!-- 구역 모달(드롭다운) -->
  <div class="modal fade" id="zoneModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">구역 저장</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <p class="mb-2">면적: <span class="fw-bold" id="modalArea">0</span> m²</p>

          <select id="zoneNameSelect" class="form-select mb-2">
            <option value="거실">거실</option>
            <option value="주방">주방</option>
            <option value="안방">안방</option>
            <option value="방">방</option>
            <option value="욕실">욕실</option>
            <option value="발코니">발코니</option>
            <option value="현관">현관</option>
            <option value="기타(직접입력)">기타(직접입력)</option>
          </select>

          <input type="text" class="form-control" id="zoneNameInput" placeholder="기타 선택 시 직접 입력">
          <small class="text-secondary d-block mt-2">
            * 욕실/방/발코니는 자동으로 번호가 붙습니다 (예: 욕실, 욕실2, 욕실3)
          </small>
        </div>

        <div class="modal-footer">
          <button class="btn btn-primary fw-bold" onclick="saveZone()">저장</button>
        </div>
      </div>
    </div>
  </div>

</div>
<!-- /screen-draw -->

<!-- 보관함 -->
<div id="screen-list" class="screen">
  <div class="screen-header bg-dark p-2 p-md-3 sticky-top border-bottom border-secondary d-flex justify-content-between align-items-center flex-wrap gap-2">
    <button type="button" class="btn btn-secondary btn-sm touch-btn" onclick="goScreen('main')"><i class="bi bi-house"></i> 홈</button>
    <h5 class="text-white m-0 fw-bold screen-title">도면 보관함</h5>
    <div class="d-flex gap-1 flex-wrap justify-content-end">
      <button type="button" class="btn btn-outline-warning btn-sm touch-btn" onclick="if(window.cleanupUnconnectedDrawings) window.cleanupUnconnectedDrawings();" title="현장별 최신 1건만 남기고 중복·오래된 행 삭제">연결 정리</button>
      <button type="button" class="btn btn-outline-light btn-sm touch-btn" onclick="if(window.checkDrawingStorageConnection) window.checkDrawingStorageConnection();">연결 확인</button>
    </div>
  </div>
  <div class="container-fluid container-sm py-3 px-2 px-sm-3 list-body" id="list-container"></div>
</div>

<!-- 견적 -->
<div id="screen-estimate" class="screen">
  <div class="screen-header bg-dark p-2 p-md-3 sticky-top border-bottom border-secondary d-flex justify-content-between align-items-center flex-wrap gap-2">
    <button type="button" class="btn btn-secondary btn-sm touch-btn" onclick="goScreen('main')"><i class="bi bi-house"></i> 홈</button>
    <h5 class="text-white m-0 fw-bold screen-title"><i class="bi bi-calculator me-1"></i>견적 내기</h5>
    <div class="invisible btn btn-sm">홈</div>
  </div>
  <div class="container-fluid container-sm py-3 px-2 px-sm-3 screen-body" id="estimate-container"></div>

  <!-- PDF 미리보기 모달 (앱 내부에서 열기) -->
  <div class="modal fade" id="pdfPreviewModal" tabindex="-1" aria-labelledby="pdfPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen modal-dialog-scrollable">
      <div class="modal-content bg-dark">
        <div class="modal-header border-secondary">
          <h5 class="modal-title text-white" id="pdfPreviewModalLabel"><i class="bi bi-file-pdf me-1"></i>견적서 미리보기</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body p-0 d-flex flex-column">
          <iframe id="pdfPreviewIframe" style="width:100%;flex:1;min-height:70vh;border:none;background:#fff;"></iframe>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-primary" id="pdfPreviewPrintBtn">
            <i class="bi bi-printer me-1"></i>인쇄하여 PDF로 저장
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 일정 -->
<div id="screen-schedule" class="screen">
  <div class="screen-header bg-dark p-2 p-md-3 sticky-top border-bottom border-secondary d-flex justify-content-between align-items-center flex-wrap gap-2">
    <button type="button" class="btn btn-secondary btn-sm touch-btn" onclick="goScreen('main')"><i class="bi bi-house"></i> 홈</button>
    <h5 class="text-white m-0 fw-bold screen-title"><i class="bi bi-calendar3 me-1"></i>일정</h5>
    <div class="invisible btn btn-sm">홈</div>
  </div>
  <div class="container-fluid container-sm py-3 px-2 px-sm-3 screen-body" id="schedule-container"></div>

  <!-- 일정 PDF 미리보기 모달 (앱 내부) -->
  <div class="modal fade" id="schedulePdfModal" tabindex="-1" aria-labelledby="schedulePdfModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen modal-dialog-scrollable">
      <div class="modal-content bg-dark">
        <div class="modal-header border-secondary">
          <h5 class="modal-title text-white" id="schedulePdfModalLabel"><i class="bi bi-file-pdf me-1"></i>PDF 미리보기</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body p-0 d-flex flex-column">
          <iframe id="schedulePdfIframe" style="width:100%;flex:1;min-height:70vh;border:none;background:#fff;"></iframe>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-primary" id="schedulePdfPrintBtn">
            <i class="bi bi-printer me-1"></i>인쇄하여 PDF로 저장
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 관리자 세팅 -->
<div id="screen-settings" class="screen">
  <div class="screen-header bg-dark p-2 p-md-3 sticky-top border-bottom border-secondary d-flex justify-content-between align-items-center flex-wrap gap-2">
    <button type="button" class="btn btn-secondary btn-sm touch-btn" onclick="goScreen('main')"><i class="bi bi-house"></i> 홈</button>
    <h5 class="text-white m-0 fw-bold screen-title"><i class="bi bi-gear-fill me-1"></i>관리자 세팅</h5>
    <div class="invisible btn btn-sm">홈</div>
  </div>
  <div class="container-fluid container-sm py-3 px-2 px-sm-3 screen-body" id="settings-container"></div>
</div>

<!-- 스크립트 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<?!= include('js_main'); ?>
<?!= include('js_drawing'); ?>
<?!= include('js_history'); ?>
<?!= include('js_estimate'); ?>
<?!= include('js_schedule'); ?>
<?!= include('js_settings'); ?>

</body>
</html>
